# stages: [build, deploy]: Äá»‹nh nghÄ©a hai stages cá»§a pipeline lÃ  build vÃ  deploy.

.BUILD:
  stage: build
  image: docker:20 # Sá»­ dá»¥ng image docker:20, cÃ¹ng vá»›i docker:20-dind lÃ m dá»‹ch vá»¥ Ä‘á»ƒ há»— trá»£ Docker trong Docker (dind)
  services: [docker:20-dind]

  # KhÃ´ng sá»­ dá»¥ng cache cá»§a GitLab CI (cache: []), thay vÃ o Ä‘Ã³, cache cá»§a Docker image Ä‘Æ°á»£c dÃ¹ng.
  cache: [] # Disable cache, since we use image cache instead

  # Kiá»ƒm tra vÃ  Ä‘Äƒng nháº­p Docker: Äáº£m báº£o Docker dind Ä‘Ã£ sáºµn sÃ ng báº±ng cÃ¡ch thá»­ docker info nhiá»u láº§n vá»›i thá»i gian chá» 5 giÃ¢y.
  # ÄÄƒng nháº­p Docker Registry: Sá»­ dá»¥ng cÃ¡c biáº¿n CI_REGISTRY_USER vÃ  CI_REGISTRY_PASSWORD Ä‘á»ƒ Ä‘Äƒng nháº­p.

  # Build Cache:
  # Pull image tá»« registry vá»›i tag cache, náº¿u cÃ³, dÃ¹ng lÃ m cache Ä‘á»ƒ tÄƒng tá»‘c build.
  # Build láº¡i cache image cho base stage trong Dockerfile, Ä‘á»ƒ dÃ¹ng lÃ m cache cho cÃ¡c build sau.
  # Build Final Image:
  # Sá»­ dá»¥ng cache vÃ  build image cuá»‘i vá»›i cÃ¡c tags lÃ  CI_COMMIT_REF_SLUG vÃ  CI_COMMIT_SHORT_SHA.

  # Push Image:
  # Push táº¥t cáº£ cÃ¡c tags cá»§a image vá»«a build vÃ o registry.

  script:
    - echo "ğŸ¤– Preparing..."
    # sometimes dind svc seems too long to start and/or dind certs are long to be available on builder
    - i=0; while [ "$i" -lt 20 ]; do docker info && break; sleep 5; i=$(( i + 1 )) ; done
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - echo "ğŸ— Build Cache"
    - docker pull $CI_REGISTRY_IMAGE:cache || true
    # Build cache image, target "base" stage
    - >-
      docker build
      --cache-from $CI_REGISTRY_IMAGE:cache
      --tag $CI_REGISTRY_IMAGE:cache
      --target base
      .
    - echo "ğŸ— Building Apps"
    # Build final image
    - >-
      docker build
      --cache-from $CI_REGISTRY_IMAGE:cache
      --tag $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
      --tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
      --target final
      .
    # Push final image
    - docker push --all-tags $CI_REGISTRY_IMAGE

.DEPLOY:
  stage: deploy
  # Sá»­ dá»¥ng image toanzzz/kubectl Ä‘á»ƒ tÆ°Æ¡ng tÃ¡c vá»›i Kubernetes.
  image: { name: toanzzz/kubectl }
  rules:
    # UAT Deploy: Náº¿u branch lÃ  deploy/uat, pipeline sáº½ Ä‘áº·t TARGET_ENV thÃ nh uat
    # Production Deploy: Náº¿u branch lÃ  deploy/prod, pipeline sáº½ Ä‘áº·t TARGET_ENV thÃ nh prod.

    - if: '$CI_COMMIT_BRANCH == "deploy/uat"'
      variables: { TARGET_ENV: uat }
    - if: '$CI_COMMIT_BRANCH == "deploy/prod"'
      variables: { TARGET_ENV: prod }
  script:
    # Thay tháº¿ cÃ¡c biáº¿n mÃ´i trÆ°á»ng trong file k8s/_kustomization.yaml vÃ  lÆ°u thÃ nh k8s/kustomization.yaml.
    # Sá»­ dá»¥ng context b4906/ci-cd-agent:prod Ä‘á»ƒ káº¿t ná»‘i Ä‘áº¿n cluster.
    # Cháº¡y lá»‡nh kubectl apply -k k8s Ä‘á»ƒ triá»ƒn khai vá»›i Kustomize, dá»±a trÃªn k8s/kustomization.yaml.

    - cat k8s/_kustomization.yaml | envsubst > k8s/kustomization.yaml
    - kubectl config use-context b4906/ci-cd-agent:prod
    - kubectl apply -k k8s

stages: [build, deploy]

# Cháº¡y job build theo cáº¥u hÃ¬nh tá»« .BUILD
# Cháº¡y job deploy theo cáº¥u hÃ¬nh tá»« .DEPLOY.
'ğŸ›  build': { extends: .BUILD }
'ğŸš€ deploy': { extends: .DEPLOY }
# Pipeline nÃ y tá»± Ä‘á»™ng build vÃ  deploy image Docker vÃ o Kubernetes cluster
# dá»±a trÃªn mÃ´i trÆ°á»ng vÃ  nhÃ¡nh (branch) cá»§a commit.
# Viá»‡c sá»­ dá»¥ng Docker cache vÃ  Kustomize giÃºp tÄƒng hiá»‡u suáº¥t vÃ  kháº£ nÄƒng cáº¥u hÃ¬nh linh hoáº¡t khi triá»ƒn khai á»©ng dá»¥ng.
